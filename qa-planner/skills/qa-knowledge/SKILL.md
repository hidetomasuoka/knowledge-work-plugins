---
name: qa-knowledge
description: QA 基準・波及リスク判定ルール・アーキテクチャ知識。テスト設計書またはリグレッションテスト計画書を生成するコマンドから自動参照される。
---

# QA Knowledge

PR の変更内容を分析し、テスト範囲と波及リスクを判定するための QA 基準・ルールを定義する。

## 変更タイプの分類と波及リスク

### 🔴 高リスク変更（必須テスト範囲が広い）

| 変更タイプ | 典型的な波及 | 確認すべき観点 |
|-----------|------------|--------------|
| 認証・認可ロジック | 全エンドポイント・全ユーザータイプ | ログイン、権限昇格、セッション |
| 共通ミドルウェア / フィルタ | 全リクエスト経路 | エラーハンドリング、ロギング |
| DB スキーマ変更 | データ読み書き全般 | マイグレーション前後の整合性 |
| 公開 API の変更 | 下流サービス・クライアント | 後方互換性、バージョン管理 |
| イベント / メッセージ仕様変更 | Subscriber サービス全体 | メッセージフォーマット、順序保証 |
| 共通ライブラリのバージョンアップ | 依存する全サービス | 破壊的変更の有無 |

### 🟡 中リスク変更（特定機能の波及を確認）

| 変更タイプ | 典型的な波及 | 確認すべき観点 |
|-----------|------------|--------------|
| ビジネスロジック変更 | 関連するユーザーフロー | 計算結果・条件分岐の正確性 |
| 外部 API 連携 | 連携先サービスとの統合 | タイムアウト・エラー処理 |
| キャッシュ戦略変更 | キャッシュ利用機能全般 | 整合性・無効化タイミング |
| バリデーション変更 | データ入力フォーム・API リクエスト | 既存データの後方互換 |
| 環境変数・設定変更 | 設定値を参照する機能 | STG/本番での差分 |

### 🟢 低リスク変更（直接関係する機能のみ確認）

| 変更タイプ | 典型的な波及 | 確認すべき観点 |
|-----------|------------|--------------|
| UI 表示のみの変更 | 変更した画面 | 見た目・レイアウト崩れ |
| ログ出力変更 | ログ監視 | 必要な情報が出力されるか |
| パフォーマンス改善（ロジック不変） | 変更したモジュール | 同等の出力・レスポンス改善 |
| テストコードのみ | なし | テストが通るか |
| ドキュメント・コメントのみ | なし | スキップ可 |

## 波及リスク判定フロー

```
1. 変更ファイルのパスを確認
   ├─ /auth/ /middleware/ /common/ → 🔴 高リスク
   ├─ /models/ /migrations/ → 🔴 高リスク（DB変更）
   ├─ /api/v*/  → 変更内容確認（破壊的変更なら 🔴）
   └─ /components/ /views/ → 🟢 低リスク（ロジックなし）

2. diff の内容を確認
   ├─ 関数シグネチャ変更 → 呼び出し元を調査
   ├─ 条件分岐の追加・変更 → テストケース増加
   ├─ イベント発行コードの変更 → Subscriber を調査
   └─ 設定値の変更 → 環境差異を確認

3. knowledge/service-dependency.md を参照
   └─ 変更されたサービス/モジュールを依存グラフで確認
```

## テスト設計の原則

### テストケース作成時

- **正常系（Happy Path）**: 期待通りの入力・操作で期待通りの結果
- **境界値テスト**: 最大・最小・空・null の各ケース
- **異常系**: エラー時のメッセージ・フォールバック動作
- **権限テスト**: 権限あり/なしユーザーでの動作差異
- **状態テスト**: 変更前後のデータ整合性

### リグレッション観点

- 変更したコードが触れていない既存機能の代表的なパスを1〜2件確認
- 過去インシデント（`knowledge/incident-history.md`）と同パターンの変更は必ずテスト
- デプロイ後の動作確認手順（スモークテスト）を最低1件含める

## テスト項目テンプレート

各テスト項目は以下の形式で記述する：

```markdown
| # | テスト項目 | 前提条件 | 操作手順 | 期待結果 | 優先度 |
|---|-----------|---------|---------|---------|-------|
| 1 | ログインできること | 有効なアカウントが存在する | メールとパスワードを入力してログインボタンを押す | ダッシュボードに遷移する | ✅ 必須 |
```

## テストデータの注意事項

- 本番データをテスト環境に持ち込まないこと
- 個人情報を含むテストデータは使用禁止
- テスト後にデータを元の状態に戻す手順を明記すること
- 共有環境でのテストは他ユーザーへの影響に注意
